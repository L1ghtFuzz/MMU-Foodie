{% extends "base.html" %}

{% block title %}MMU Foodie{% endblock %}

{% block body %}
<div class="container">
  <div class="filters">
    <div class="filter-section">

      <h3>Price</h3>
      <div class="price-buttons segmented">
        <button>$</button>
        <button>$$</button>
        <button>$$$</button>
        <button>$$$$</button>
      </div>

      <h3>Suggested</h3>
      <div class="checkbox-option">
        <label>
          <span>Open Now</span>
          <input type="checkbox">
        </label>
      </div>

      <div class="checkbox-option">
        <label>
          <span>Offers Delivery</span>
          <input type="checkbox">
        </label>
      </div>

      <div class="see-more-container">
        <div class="container1">

          <h3>Category</h3>
          <button class="category">Local</button>
          <button class="category">Western</button>
          <button class="category">Chinese</button>
          <button class="category">Fast Food</button>
          <span class="more-category">
            <button class="category">Japanese</button>
            <button class="category">Italian</button>
            <button class="category">Korean</button>
          </span>
          <span class="see-more-btn">Show More</span>

        </div>
      </div>

      <div class="rating-container">
        <div>
          <h3>Ratings</h3>
          <label>Min Rating: <input type="number" id="rating" step="1" min="1" max="5"></label>
        </div>
      </div>

      <button onclick="applyFilters()">Apply</button>

      <ul id="results"></ul>
    </div>

  </div>

  <div class="details">
    <!-- Restaurant descriptions go here -->
  </div>
  <div class="map">
    <div id="map"></div>
  </div>
</div>
<script>

  // Filters Apply Function
  async function applyFilters() {
    const prices = [...document.querySelectorAll('.price:checked')].map(el => el.value);
    const categories = [...document.querySelectorAll('.category:checked')].map(el => el.value);
    const rating = parseFloat(document.getElementById('rating').value) || 0;

    const response = await fetch('/filter', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ price: prices, category: categories, rating })
    });

    const data = await response.json();
    const results = document.getElementById('results');
    results.innerHTML = data.map(r => `<li>${r.name} - ${r.price} - ${r.category} - ${r.rating}</li>`).join('');
  }

  //*Show More Show Less
  const parentContainer = document.querySelector('.see-more-container');
  parentContainer.addEventListener('click', event => {
    const current = event.target;
    const isSeeMoreBtn = current.className.includes('see-more-btn');
    if (!isSeeMoreBtn) return;
    const currentText = event.target.parentNode.querySelector('.more-category');
    currentText.classList.toggle('more-category--show');
    current.textContent = current.textContent.includes('Show More') ?
      "Show Less" : "Show More";
  })

  // Price button
  const priceButtons = document.querySelectorAll('.price-buttons.segmented button');

  priceButtons.forEach(button => {
    button.addEventListener('click', () => {
      priceButtons.forEach(btn => btn.classList.remove('active'));
      button.classList.add('active');
    });
  });

  // Script for Leaflet Map //
  const map = L.map('map').setView([2.927891727185679, 101.6418836043987], 15);
  var osm = L.tileLayer('https://tile.thunderforest.com/atlas/{z}/{x}/{y}.png?apikey=e001824582174c60bd8de623bc429bb6', {
    maxZoom: 19,
    attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
  })
  osm.addTo(map);

  var popup = L.popup();
  var marker = L.marker([2.927891727185679, 101.6418836043987]).addTo(map);
  marker.bindPopup("<b>Multimedia University").openPopup();

  map.on('click', onMapClick);

</script>
{% endblock %}