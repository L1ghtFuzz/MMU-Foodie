{% extends "base.html" %}

{% block title %}MMU Foodie{% endblock %}

{% block style %}
<style>
  a {
  text-decoration: none;
  color: inherit;
}

a:hover {
  text-decoration: none;
  color: #0050a2;
}

.restaurant-card {
  display: flex;
  border: 1px solid #eee;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.05);
  padding: 1rem;
  margin-bottom: 1rem;
  transition: box-shadow 0.3s ease-in-out;
  background-color: #fff;
}

.restaurant-card:hover {
  box-shadow: 0 6px 16px rgba(0,0,0,0.1);
}

.restaurant-image {
  width: 210px;
  height: 170px;
  object-fit: cover;
  border-radius: 3px;
  margin-right: 1rem;
}

.restaurant-info h2 {
  margin-top: 0;
  font-size: 1.2rem;
}

.restaurant-info p {
  margin: 0.3rem 0;
}

.category {
  padding: 6px 10px;
  margin: 4px;
  border-radius: 20px;
  border: 1px solid #ccc;
  background-color: #fff;
  font-size: 0.9rem;
  cursor: pointer;
  transition: all 0.2s ease-in-out;
}

.category:hover {
  background-color: #f0f0f0;
  border-color: #aaa;
}

.category.active {
  background-color: #0050a2;
  color: white;
  border-color: #0050a2;
}

.rating-container select {
  padding: 6px 10px;
  border-radius: 8px;
  border: 1px solid #ccc;
  background-color: #fff;
  font-size: 0.9rem;
  color: #333;
  margin-top: 0.5rem;
  width: 100%;
  max-width: 150px;
}

.rating-container label {
  display: block;
  font-size: 0.95rem;
  color: #333;
  margin-bottom: 0.5rem;
}

.filter-group {
  border-bottom: 1px solid #ddd;
  padding-bottom: 1rem;
  margin-bottom: 1rem;
}

</style>
{% endblock %}

{% block body %}
<div class="container">
  <div class="filters">
    <h5><b>Filters</b></h5>
    <div class="filter-section">

      <div class="filter-group">
      <h6><b>Price</b></h6>
      <div class="price-buttons segmented">
        <div class="price-buttons segmented">
          <button onclick="updateURLParam('price', '$')">$</button>
          <button onclick="updateURLParam('price', '$$')">$$</button>
          <button onclick="updateURLParam('price', '$$$')">$$$</button>
          <button onclick="updateURLParam('price', '$$$$')">$$$$</button>
        </div>
      </div>
      </div>


      <div class="filter-group">
        <h6><b>Suggested</b></h6>
        <div class="checkbox-option">
          <label>
            <span>Open Now</span>
            <input type="checkbox"><br>
            <span>Offers Delivery</span>
            <input type="checkbox">
          </label>
        </div>
      </div>


      <div class="see-more-container">
        <div class="container1">
          <div class="filter-group">
          <h6><b>Category</b></h6>
          <button onclick="updateURLParam('category', 'Local')" class="category">Local</button>
          <button onclick="updateURLParam('category', 'Western')" class="category">Western</button>
          <button onclick="updateURLParam('category', 'Chinese')" class="category">Chinese</button>
          <button onclick="updateURLParam('category', 'Fast Food')" class="category">Fast Food</button>
          <span class="more-category">
            <button onclick="updateURLParam('category', 'Japanese')" class="category">Japanese</button>
            <button onclick="updateURLParam('category', 'Italian')" class="category">Italian</button>
            <button onclick="updateURLParam('category', 'Korean')" class="category">Korean</button>
            <button onclick="updateURLParam('category', 'French')" class="category">French</button>
          </span>
          <span class="see-more-btn">Show More</span>

          </div>
        </div>
      </div>

      <div class="rating-container">
        <div class="filter-group">
          <h6><b>Ratings</b></h6>
          <label>Min Rating: 
            <select onchange="updateURLParam('rating', this.value)">
              <option value="">--</option>
              <option value="1">1+</option>
              <option value="2">2+</option>
              <option value="3">3+</option>
              <option value="4">4+</option>
            </select>
          </label>
        </div>
      </div>

    <button onclick="clearFilters()" style="margin-left: 0.5rem;">Clear</button>

      <ul id="results"></ul>
    </div>
  </div>

  <div class="details">
    {% for restaurant in restaurants %}
        <a href="{{ url_for('display_restaurant', restaurant_id=restaurant.id) }}">        <div class="restaurant-card">
          <img src="{{ restaurant.image_url or url_for('static', filename='default.jpg') }}" alt="{{ restaurant.name }}" class="restaurant-image">
          <div class="restaurant-info">
            <h2><b>{{ restaurant.name }}</b></h2>
            <p><strong>Cuisine:</strong> {{ restaurant.cuisine }}</p>
            <p><strong>Rating:</strong> {{ restaurant.avg_rating }} / 5</p>
            <p><strong>Price:</strong> {{ restaurant.price }}</p>
          </div>
        </div>
      </a>
    {% endfor %}
  </div>

  <div class="map">
    <div id="map"></div>
  </div>
</div>
<script>
    function updateURLParam(key, value) {
      const url = new URL(window.location.href);
      const params = url.searchParams;

      let existing = params.get(key);
      let values = existing ? existing.split(',') : [];

      if (values.includes(value)) {
        values = values.filter(v => v !== value);
      } else {
        values.push(value);
      }

      if (values.length > 0) {
        params.set(key, values.join(','));
      } else {
        params.delete(key);
      }

      url.search = params.toString();
      window.location.href = url.toString();
    }

    function clearFilters() {
    const url = new URL(window.location.href);
    url.search = '';
    window.history.replaceState({}, '', url.toString());
    document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);

    priceButtons.forEach(btn => btn.classList.remove('active'));
    categoryButtons.forEach(btn => btn.classList.remove('active'));
    const ratingSelect = document.querySelector('select');
    if (ratingSelect) ratingSelect.value = '';

    document.getElementById('results').innerHTML = '';
    window.location.reload();
  }

    // Price button
    const priceButtons = document.querySelectorAll('.price-buttons.segmented button');

    priceButtons.forEach(button => {
      button.addEventListener('click', () => {
        priceButtons.forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
      });
    });

    // Category Filter
    const categoryButtons = document.querySelectorAll('.category');

    categoryButtons.forEach(button => {
      button.addEventListener('click', () => {
        button.classList.toggle('active');
      });
    });

  //*Show More Show Less
  const parentContainer = document.querySelector('.see-more-container');
  parentContainer.addEventListener('click', event => {
    const current = event.target;
    const isSeeMoreBtn = current.className.includes('see-more-btn');
    if (!isSeeMoreBtn) return;
    const currentText = event.target.parentNode.querySelector('.more-category');
    currentText.classList.toggle('more-category--show');
    current.textContent = current.textContent.includes('Show More') ?
      "Show Less" : "Show More";
  })

  // Initialize the map
  const map = L.map('map').setView([2.927891727185679, 101.6418836043987], 15);

  // Add the tile layer
  L.tileLayer('https://tile.thunderforest.com/atlas/{z}/{x}/{y}.png?apikey=e001824582174c60bd8de623bc429bb6', {
    maxZoom: 19,
    attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
  }).addTo(map);

  var marker = L.marker([2.927891727185679, 101.6418836043987]).addTo(map);
  marker.bindPopup("<b>Multimedia University").openPopup();

  // Loop through restaurants and add markers
  {% for restaurant in restaurants %}
    {% if restaurant.latitude and restaurant.longitude %}
      L.marker([{{ restaurant.latitude }}, {{ restaurant.longitude }}])
        .addTo(map)
        .bindPopup("<b>{{ restaurant.name }}</b><br>{{ restaurant.cuisine }}<br>Rating: {{ restaurant.avg_rating }} / 5");
    {% endif %}
  {% endfor %}

</script>
<script src="{{ url_for('static', filename='script.js') }}"></script>
<script src="{{ url_for('static', filename='data/point.js') }}"></script>
{% endblock %}